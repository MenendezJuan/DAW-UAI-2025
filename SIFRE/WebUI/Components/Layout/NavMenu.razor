@using BE.Enums
@using Infrastructure.Session

@rendermode InteractiveServer

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">SIFRE</a>
    </div>
</div>

<div class="nav-scrollable">
    <nav class="flex-column">

        @if (HasAnyPermission(new[] {
            PermissionsType.CONSULTAR_PUNTOS,
            PermissionsType.CANJEAR_PUNTOS
        }))
        {
            <div class="nav-item px-3">
                <button class="nav-menu-header btn w-100 text-start" @onclick="() => ToggleMenu(0)" type="button">
                    <span class="nav-link menu-title">
                        💰 Puntos
                        <span class="chevron @(menuStates[0] ? "chevron-down" : "chevron-right")">▶</span>
                    </span>
                </button>
                <div class="nav-submenu @(menuStates[0] ? "show" : "")">
                    @if (HasPermission(PermissionsType.CONSULTAR_PUNTOS))
                    {
                        <NavLink class="nav-link submenu-item" href="consultar-puntos">
                            🔍 Consultar puntos
                        </NavLink>
                    }
                    @if (HasPermission(PermissionsType.CANJEAR_PUNTOS))
                    {
                        <NavLink class="nav-link submenu-item" href="canjear-puntos">
                            🔄 Canjear puntos
                        </NavLink>
                    }
                    @if (HasPermission(PermissionsType.CONSULTAR_PUNTOS))
                    {
                        <NavLink class="nav-link submenu-item" href="transferir-puntos">
                            📤 Transferir puntos
                        </NavLink>
                    }
                </div>
            </div>
        }

        @if (HasPermission(PermissionsType.VER_PRODUCTOS))
        {
            <div class="nav-item px-3">
                <button class="nav-menu-header btn w-100 text-start" @onclick="() => ToggleMenu(1)" type="button">
                    <span class="nav-link menu-title">
                        📋 Catálogo
                        <span class="chevron @(menuStates[1] ? "chevron-down" : "chevron-right")">▶</span>
                    </span>
                </button>
                <div class="nav-submenu @(menuStates[1] ? "show" : "")">
                    <NavLink class="nav-link submenu-item" href="ver-productos">
                        📦 Ver productos
                    </NavLink>
                </div>
            </div>
        }

        @if (HasAnyPermission(new[] {
            PermissionsType.VER_REPORTERIA
        }))
        {
            <div class="nav-item px-3">
                <button class="nav-menu-header btn w-100 text-start" @onclick="() => ToggleMenu(2)" type="button">
                    <span class="nav-link menu-title">
                        📊 Reporterías
                        <span class="chevron @(menuStates[2] ? "chevron-down" : "chevron-right")">▶</span>
                    </span>
                </button>
                <div class="nav-submenu @(menuStates[2] ? "show" : "")">
                    @if (HasPermission(PermissionsType.VER_REPORTERIA))
                    {
                        <NavLink class="nav-link submenu-item" href="bitacora-eventos">
                            📅 Bitácora eventos
                        </NavLink>
                        <NavLink class="nav-link submenu-item" href="bitacora-productos">
                            📦 Bitácora productos
                        </NavLink>
                    }
                    @*<NavLink class="nav-link submenu-item" href="bitacora-reconocimientos">
                        🏆 Bitácora de reconocimientos
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="bitacora-objetivos">
                        🎯 Bitácora de objetivos
                    </NavLink>*@
                </div>
            </div>
        }

        @if (HasAnyPermission(new[] {
            PermissionsType.GESTIONAR_PRODUCTOS,
            PermissionsType.GESTIONAR_BACKUP
        }))
        {
            <div class="nav-item px-3">
                <button class="nav-menu-header btn w-100 text-start" @onclick="() => ToggleMenu(3)" type="button">
                    <span class="nav-link menu-title">
                        ⚙️ Configuración
                        <span class="chevron @(menuStates[3] ? "chevron-down" : "chevron-right")">▶</span>
                    </span>
                </button>
                <div class="nav-submenu @(menuStates[3] ? "show" : "")">
                    @*<NavLink class="nav-link submenu-item" href="gestionar-perfiles">
                        👥 Gestionar perfiles
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="gestionar-idioma">
                        🌐 Gestionar idioma
                    </NavLink>*@
                    @if (HasPermission(PermissionsType.GESTIONAR_PRODUCTOS))
                    {
                        <NavLink class="nav-link submenu-item" href="gestionar-productos">
                            🛒 Gestionar productos
                        </NavLink>
                    }
                    @if (HasPermission(PermissionsType.GESTIONAR_BACKUP))
                    {
                        <NavLink class="nav-link submenu-item" href="gestionar-backup">
                            💾 Gestionar Backup
                        </NavLink>
                    }
                </div>
            </div>
        }

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="#" @onclick="ConfirmLogout">
                🚪 Cerrar sesión
            </NavLink>
            @if (showLogoutModal)
            {
                <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">¿Confirmar cierre de sesión?</h5>
                            </div>
                            <div class="modal-body">
                                <p>¿Estás seguro de que querés cerrar sesión?</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" @onclick="CancelarLogout">Cancelar</button>
                                <button class="btn btn-danger" @onclick="Logout">Cerrar sesión</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </nav>
</div>

@code {
    [Inject] private NavigationManager NavigationManager { get; set; }
    [Inject] private ILogger<NavMenu> Logger { get; set; }

    private bool[] menuStates = new bool[7];
    private bool showLogoutModal = false;

    private void ToggleMenu(int index)
    {
        for (int i = 0; i < menuStates.Length; i++)
        {
            menuStates[i] = i == index ? !menuStates[i] : false;
        }
    }

    private void ConfirmLogout() => showLogoutModal = true;
    private void CancelarLogout() => showLogoutModal = false;

    private void Logout()
    {
        SingletonSession.Instancia.Logout();
        NavigationManager.NavigateTo("/login", true);
    }

    private bool HasPermission(PermissionsType perm)
    {
        return SingletonSession.Instancia.User != null && SingletonSession.Instancia?.IsInRole(perm) == true;
    }

    private bool HasAnyPermission(PermissionsType[] perms)
    {
        return SingletonSession.Instancia.User != null && perms.Any(p => SingletonSession.Instancia.IsInRole(p));
    }
}
